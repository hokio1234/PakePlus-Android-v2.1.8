<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½åƒè¯æé†’</title>
<style>
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{margin:0;padding:12px;background:#f4f7fa;font-size:32px}
.container{max-width:500px;margin:0 auto;background:#fff;border-radius:16px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.title{text-align:center;font-size:40px;font-weight:bold;margin:10px 0 20px;color:#222}
.tip-text{text-align:center;color:#ff3b30;font-weight:bold;margin:10px 0;font-size:32px}
.next-info{text-align:center;color:#007aff;font-weight:bold;margin:8px 0;font-size:32px}
.btn{width:100%;padding:14px;border:none;border-radius:12px;margin:6px 0;font-size:32px;background:#007aff;color:white}
.btn-gray{background:#888}
.med-btn{width:100%;padding:14px;margin:7px 0;border:none;border-radius:12px;background:#ff3b30;color:white;text-align:left;font-size:32px}
.med-btn.done{background:#34c759}
.popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;color:white;font-size:52px;z-index:999}
.panel{margin:16px 0;padding:12px;border:1px solid #ddd;border-radius:12px}
.panel-title{font-weight:bold;margin-bottom:8px;font-size:34px}
select,input{padding:8px;border-radius:8px;border:1px solid #ccc;width:100%;font-size:32px}
.history-box{max-height:260px;overflow-y:auto;padding:8px}
.history-item{padding:8px 0;border-bottom:1px solid #eee;font-size:30px}
.tab{display:flex;gap:8px;margin-bottom:12px}
.tab button{flex:1;padding:10px;border-radius:8px;border:none;background:#eee;font-size:32px}
.tab button.active{background:#007aff;color:white}
.page{display:none}
.page.show{display:block}
</style>
</head>
<body>
<div class="container">
  <div class="title">æ™ºèƒ½æé†’ç®¡å®¶</div>

  <div class="tab">
    <button class="tabbtn active" data-page="home">ä¸»é¡µ</button>
    <button class="tabbtn" data-page="setting">è®¾ç½®</button>
    <button class="tabbtn" data-page="history">è®°å½•</button>
  </div>

  <!-- ä¸»é¡µ -->
  <div id="home" class="page show">
    <div class="tip-text" id="tipText" style="display:none"></div>
    <div class="next-info" id="nextTxt"></div>
    <button class="btn" id="earlyBtn" style="display:none">æå‰åƒè¯</button>
    <div id="medArea"></div>
  </div>

  <!-- è®¾ç½® -->
  <div id="setting" class="page">
    <div class="panel">
      <div class="panel-title">é€‰æ‹©æœ¬åœ°æé†’é“ƒå£°</div>
      <input type="file" id="localAudio" accept="audio/*" style="margin-bottom:8px">
      <button class="btn btn-gray" id="playLocal">è¯•å¬å·²é€‰é“ƒå£°</button>
      <div id="audioName" style="margin-top:6px;font-size:28px;color:#666"></div>
    </div>

    <div class="panel">
      <div class="panel-title">æœè¯æ—¶é—´ä¿®æ”¹</div>
      <select id="timeSelect"></select>
      <input type="time" id="newTime" style="width:100%;margin-top:8px">
      <button class="btn btn-gray" id="saveTime">ä¿å­˜ä¿®æ”¹</button>
    </div>

    <div class="panel">
      <div class="panel-title">é‡å¤å¤©æ•°</div>
      <select id="repeatDay">
        <option value="0">æ¯å¤©é‡å¤</option>
        <option value="1">1å¤©</option>
        <option value="3">3å¤©</option>
        <option value="7">7å¤©</option>
        <option value="14">14å¤©</option>
        <option value="30">30å¤©</option>
      </select>
    </div>
  </div>

  <!-- è®°å½• -->
  <div id="history" class="page">
    <div class="panel-title">æœè¯è®°å½•</div>
    <div class="history-box" id="historyList"></div>
    <button class="btn btn-gray" id="clearHistory">æ¸…ç©ºè®°å½•</button>
  </div>

  <div class="popup" id="okPopup">ä½ çœŸæ£’ âœ…</div>
</div>

<script>
//==============================
let medSchedule = [
  {time:"08:00",name:"æ—©é¤å‰",list:["æ³®æ‰˜æ‹‰å”‘ç‰‡ 1ç‰‡"]},
  {time:"10:00",name:"é¤å1å°æ—¶",list:["èˆæ›²æ—ç‰‡ 2ç‰‡","æ²™åº“å·´æ›² 1.5ç‰‡","èºå†…é…¯ç‰‡ 1.5ç‰‡","ç”²ç£ºé…¸å€ä»–å¸æ±€ 2ç‰‡","è„‰ç®¡å¤èƒ¶å›Š 4ç‰‡","æèŠåœ°é»„ä¸¸ 8ç²’","æ»´ç»ç’ƒé…¸é’ çœ¼è¯æ°´","é‡è¡€å‹"]},
  {time:"16:00",name:"ä¸‹åˆ4ç‚¹",list:["ç”²ç£ºé…¸å€ä»–å¸æ±€ 2ç‰‡","è„‰ç®¡å¤èƒ¶å›Š 4ç‰‡","æèŠåœ°é»„ä¸¸ 8ç²’","æ»´ç»ç’ƒé…¸é’ çœ¼è¯æ°´","é‡è¡€å‹"]},
  {time:"20:00",name:"æ™šä¸Š8ç‚¹",list:["é˜¿æ‰˜ä¼ä»–æ±€ 1ç‰‡","ç”²ç£ºé…¸å€ä»–å¸æ±€ç‰‡ 2ç‰‡","è„‰ç®¡å¤èƒ¶å›Š 4ç‰‡","æèŠåœ°é»„ä¸¸ 8ç²’","æ»´ç»ç’ƒé…¸é’ çœ¼è¯æ°´","é‡è¡€å‹"]},
  {time:"21:00",name:"æ™šä¸Š9ç‚¹",list:["å¯Œé©¬é…¸å–¹ç¡«å¹³ 1ç‰‡"]}
];

//================ éŸ³é¢‘ =====================
let alertSound = new Audio();
alertSound.loop = true;
let userAudioUrl = null;

//================ å…¨å±€å˜é‡ ================
let current = null;
let done = new Set();
let timer10 = null;
let timer2h = null;
let timer1m = null;
let autoBackTimer = null;
let history = JSON.parse(localStorage.getItem("medHistory") || "[]");
let nineDone = false;

//================ å¯åŠ¨ =====================
window.onload = () => {
  tabSwitch();
  initTimeSelect();
  loadHistory();
  bindLocalAudio();
  startAutoBack();
  setInterval(checkNow, 1000);
  setInterval(showHome, 1000);
  showHome();
}

//================ æ ‡ç­¾åˆ‡æ¢ =================
function tabSwitch(){
  document.querySelectorAll(".tabbtn").forEach(b=>{
    b.onclick = () => {
      document.querySelectorAll(".tabbtn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      document.querySelectorAll(".page").forEach(p=>p.classList.remove("show"));
      document.getElementById(b.dataset.page).classList.add("show");
      resetAutoBack();
    }
  })
}

//================ 1åˆ†é’Ÿæ— æ“ä½œè¿”å›ä¸»é¡µ =====
function startAutoBack() {
  resetAutoBack();
  document.addEventListener("touchstart", resetAutoBack);
  document.addEventListener("mousemove", resetAutoBack);
  document.addEventListener("click", resetAutoBack);
}
function resetAutoBack() {
  clearTimeout(autoBackTimer);
  autoBackTimer = setTimeout(() => {
    goHome();
  }, 60000);
}
function goHome() {
  document.querySelectorAll(".tabbtn").forEach(x => x.classList.remove("active"));
  document.querySelector('[data-page="home"]').classList.add("active");
  document.querySelectorAll(".page").forEach(p => p.classList.remove("show"));
  document.getElementById("home").classList.add("show");
}

//================ ä¸»é¡µæ˜¾ç¤º =================
function showHome(){
  if(current) return;
  document.getElementById("medArea").innerHTML = "";
  document.getElementById("earlyBtn").style.display = "none";

  let now = new Date();
  let h = now.getHours();
  let isNight = (h >= 21 && nineDone) || h >= 21.5;
  let isMidnight = h >= 0;

  if (isNight && !isMidnight) {
    document.getElementById("tipText").innerText = "ç¡å‰åŠå°æ—¶åƒåŠ³æ‹‰2ç‰‡ï¼Œç¥æ‚¨åšä¸ªå¥½æ¢¦ã€‚";
    document.getElementById("tipText").style.display = "block";
  } else {
    document.getElementById("tipText").style.display = "none";
  }

  let next = getNext();
  if(!next) return;
  let [h2,m] = next.time.split(":");
  let t = new Date();
  t.setHours(h2,m,0);
  if(t < now) t.setDate(t.getDate()+1);
  let left = t - now;
  let near = left <= 2*60*60*1000;
  if(near){
    document.getElementById("nextTxt").innerText = `å³å°†ï¼š${next.name} ${next.time}`;
    let eb = document.getElementById("earlyBtn");
    eb.style.display = "block";
    eb.onclick = () => startRemind(next);
  }else{
    document.getElementById("nextTxt").innerText = `ä¸‹æ¬¡ï¼š${next.time} ${next.name}`;
  }
}

//================ æ£€æŸ¥æ—¶é—´ =================
function checkNow(){
  if(current) return;
  let now = new Date();
  let hm = now.getHours().toString().padStart(2,"0") + ":" + now.getMinutes().toString().padStart(2,"0");
  let item = medSchedule.find(x => x.time == hm);
  if(item) startRemind(item);
}

//================ å¼€å§‹æé†’ =================
function startRemind(item){
  current = item;
  done.clear();
  nineDone = item.time === "21:00";
  document.getElementById("earlyBtn").style.display = "none";

  if(alertSound.src){
    alertSound.currentTime = 0;
    alertSound.play();
  }
  timer1m = setTimeout(()=>alertSound.pause(), 60000);
  timer2h = setTimeout(stopAll, 2*60*60*1000);
  timer10 = setInterval(()=>{
    if(done.size < item.list.length && alertSound.src){
      alertSound.currentTime = 0;
      alertSound.play();
      setTimeout(()=>alertSound.pause(), 60000);
    }
  }, 10*60*1000);
  showBtns(item);
}

//================ æ˜¾ç¤ºè¯å“æŒ‰é’® =============
function showBtns(item){
  let area = document.getElementById("medArea");
  area.innerHTML = `<div style='text-align:center;font-weight:bold;margin:10px;font-size:32px'>${item.name} æœè¯</div>`;
  item.list.forEach((s,i)=>{
    let btn = document.createElement("button");
    btn.className = "med-btn";
    btn.innerText = s;
    btn.onclick = () => {
      btn.classList.add("done");
      btn.innerText = "ğŸ‘ " + s;
      done.add(i);
      checkAll();
    }
    area.appendChild(btn);
  })
}

//================ æ£€æŸ¥å…¨éƒ¨å®Œæˆ =============
function checkAll(){
  if(!current) return;
  if(done.size == current.list.length){
    stopAll();
    addHistory(current.name, current.time);
    let p = document.getElementById("okPopup");
    p.style.display = "flex";
    setTimeout(()=>p.style.display = "none", 5000);
  }
}

//================ åœæ­¢æ‰€æœ‰ =================
function stopAll(){
  alertSound.pause();
  clearInterval(timer10);
  clearTimeout(timer2h);
  clearTimeout(timer1m);
  current = null;
  done.clear();
  showHome();
}

//================ ä¸‹ä¸€æ¬¡æ—¶é—´ ===============
function getNext(){
  let now = new Date();
  let nowM = now.getHours()*60 + now.getMinutes();
  let arr = medSchedule.map(x=>{
    let [h,m] = x.time.split(":");
    return {...x, total: h*60 + m*1};
  });
  let today = arr.filter(x => x.total > nowM);
  if(today.length) return today[0];
  return arr[0];
}

//================ æœ¬åœ°éŸ³é¢‘é€‰æ‹© =============
function bindLocalAudio() {
  const fileInput = document.getElementById("localAudio");
  const playBtn = document.getElementById("playLocal");
  const nameLabel = document.getElementById("audioName");

  fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return;
    userAudioUrl = URL.createObjectURL(file);
    alertSound.src = userAudioUrl;
    nameLabel.textContent = "å·²é€‰æ‹©ï¼š" + file.name;
  };

  playBtn.onclick = () => {
    if (alertSound.src) {
      alertSound.currentTime = 0;
      alertSound.play();
      setTimeout(()=> alertSound.pause(), 3000);
    } else {
      alert("è¯·å…ˆé€‰æ‹©æœ¬åœ°éŸ³é¢‘æ–‡ä»¶ï¼");
    }
  };
}

//================ æ—¶é—´ä¿®æ”¹ =================
function initTimeSelect(){
  let sel = document.getElementById("timeSelect");
  sel.innerHTML = "";
  medSchedule.forEach((x,i)=>{
    let op = document.createElement("option");
    op.value = i;
    op.innerText = x.name + " " + x.time;
    sel.appendChild(op);
  })
  document.getElementById("saveTime").onclick = () => {
    let i = sel.value * 1;
    let t = document.getElementById("newTime").value;
    if(t){
      medSchedule[i].time = t;
      alert("ä¿®æ”¹æˆåŠŸï¼");
      initTimeSelect();
    }
  }
}

//================ è®°å½• =================
function addHistory(title,time){
  let d = new Date();
  let str = d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate() + " " +
            d.getHours() + ":" + d.getMinutes().toString().padStart(2,"0");
  history.unshift(title + " " + time + " â€”â€” å·²å®Œæˆ " + str);
  if(history.length > 100) history = history.slice(0,100);
  localStorage.setItem("medHistory", JSON.stringify(history));
  loadHistory();
}
function loadHistory(){
  let b = document.getElementById("historyList");
  b.innerHTML = history.map(s => `<div class='history-item'>${s}</div>`).join("");
}
document.getElementById("clearHistory").onclick = () => {
  history = [];
  localStorage.setItem("medHistory", "[]");
  loadHistory();
}
</script>
</body>
</html>
